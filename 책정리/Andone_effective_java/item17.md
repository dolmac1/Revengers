# item 17 변경 가능성을 최소화 하라

불변 클래스란 그 인스턴스의 내부 값을 수정할 수 없는 클래스이다. 불변 인스턴스에 간직된 정보는 고정되어 객체가 파괴되는 순간까지 절대 달라지지 않는다. Java에서도 여러가지 불변 클래스를 제공하고 있다. *__"불변 클래스는 가변 클래스보다 설계하고 구현하고 사용하기 쉬우며, 오류가 생길 여지가 적다."__*

불변 클래스로 만들고자 하면 다음과 같은 다섯 가지 규칙을 따르면 된다.

- 객체의 상태를 변경하는 메서드(변경자)를 제공하지 않는다.
- 클래스를 확장할 수 없도록한다. 하위 클래스에서 객체의 상태를 잘못 변화시키는 것을 막기위함이다. 클래스를 final로 선언하는 방식이 대표적이지만 후에 다양한 방식을 볼 것이다.
- 모든 필드를 final로 선언한다.
- 모든 필드를 private으로 선언한다.
- 자신 외에는 내부 가변 컴포넌트에 접근할 수 없도록 한다.

```java
public final class Complex {
  private final double re;
  private final double im;
  
  public Complex(double re, double im) {
    this.re = re;
    this.im = im;
  } 
  
  public Complex plus(Complex c) {
    return new Complex(re + c.re, im + c.im);
  }
}
```

위 예시를 보면 plus 메서드는 새로운 인스턴스를 만들어서 반환한다. 이처럼 피연산자에 함수를 적용해 그 결과를 반환하지만, 피 연산자 자체는 그대로인 프로그래밍 패턴을 함수형 프로그래밍이라 한다. 이와 달리, 절차형 혹은 명령형 프로그래밍에서는 메서드 이름으로 (add 같은) 동사대신 (plus 같은) 전치사를 사용한 점에도 주목하자. 이는 해당 메서드가 객체의 값을 변경하지 않는다는 사실을 강조하려는 의미이다. 이 명명 의미를 따르지 않는 BigInteger와 같은 클래스들이 잘못 사용해 오류가 발생하는 일이 자주 있다.

함수형 프로그래밍을 이용한다면 코드에서 불변이 되는 영역의 비율이 높아지는 장점을 누릴 수 있으며 __불변 객체는 단순하다.__ 불변 객체는 생성된 시점의 상태를 파괴될 때까지 그대로 간직한다. 모든 생성자가 클래스 불변식을 보장한다면 그 클래스를 사용하는 프로그래머가 다른 노력을 들이지 않더라도 불변으로 남는다.

### 불변 객체의 장점

- __불변 객체는 근본적으로 스레드 세이프티 하여 따로 동기화 할 필요가 없다.__ 그래서 스레드가 영향을 끼칠 것을 걱정하지 않고 안심하고 공유할 수 있다.

- 불변 객체는 자주 사용되는 인스턴스를 캐싱하여 인스턴스를 중복 생성하지 않게 해주는 정적 팩터리 메서드를 제공할 수 있다. 이런 정적 팩터리를 사용하게 되면 여러 클라이언트가 인스턴스를 공유하게 되어 메모리 사용량과 가비지 컬랙션 내용이 줄어든다.

- 불변 객체는 복사가 필요 없다. 불변 객체는 복사해도 같은 객체이기 때문에 복사를 할 필요가 없다.
- 불변 객체는 자유롭게 공유할 수 있으며, 북변객체 끼리는 데이터를 공유할 수 있다. 예를들어 BinInter 클래스는 내부에서 값의 부호와 크기를 따로 표현한다. 그 안에 있는 negate 메서드는 크기가 같고 부호만 반대인 새로운 BigInteger를 생성하는데, 이때 배열은 비록 가변이지만 복사하지 않고 인스턴스와 공유해도 된다.
- 객체를 만들때 다른 불변 객체들을 구성요소로 사용하면 이점이 많은데, 값이 바뀌지 않는 구성요소들로 이뤄진 객체라면 그 구조가 아무리 복잡 하더라도 불변식을 유지하기 쉽다. 가장 좋은 예로 불변 객체는 맵의 키와 집합의 원소로 쓰이기 안성 맞춤이다. 맵이나 셋은 담긴 값이 바뀌면 불변식이 허물어 지지만 불변객체는 이러한 것을 걱정할 필요가 없다.
- 불변 객체는 그 자체로 실패 원자성을 제공한다. 왜냐면 상태가 영원히 바뀌지 않기 때문에 불일치 상태가 될 수 없다.

### 불변 클래스의 단점

- 값이 다르면 반드시 독립된 객체로 만들어야 한다. 값의 가지수가 많다면 이것을 모두 만들어야 한다는 문제점이 발생할 수 있다.
- 원하는 객체를 완성하기 까지의 단계가 많고 그 중간 단계에서 만들어진 객체들이 모두 버려진다면 성능 문제가 발생한다.
  해당 문제를 해결하는 방법은 두가지가 있다.
  1. 다단계 연산들을 예측하여 기본 기능으로 제공하는 방식이다. 이러한 다단계 연산을 기본으로 제공한다면 각 단계마다 객체를 생성하지 않아도 된다. BigInteger는 모듈러 지수 같은 다단계 연산 속도를 높여주는 가변 동반 클래스를 package-private으로 두고있다.
     *모듈러 지수 연산이란 암호학에서 흔히 쓰이는 연산으로 모드 연산의 특징을 이용한 연산의 일종이다.*
  2. 흔히 쓰일 다단계 연산이 예측되지 않는 경우 가변 동반 클래스를 public으로 제공하는 것이다. 대표적인 예로 String이 있고 가변 동반 클래스로는 StringBuilder와 StringBuffer 클래스가 있다.

### 불변 클래스를 생성하는 다른 방법

이전에 불변클래스는 상속이 불가능 해야하며 final 클래스로 선언하는 방식이 가장 쉽다고 한것이 기억나는가? 하지만 이 방법 말고도 다른 방법이 있다.

모든 생성자를 private 혹은 package-private으로 만들고 public 정적 팩터리 메서드를 제공하는 방식이다. 이 방식은 밖에서 볼 수 없는 package-private 구현 클래스를 원하는 만큼 만들어 활용할 수 있으니 훨씬 유연하며 패키지 바깥의 클래스 클라이언트에서 바라본 이 불변 객체는 사실상 final이다. 그리고 정적 팩터리 메서드 방식을 이용하여 다수의 구현 클래스를 활용해 유연함을 만들어 낼 수 있다.



### 클래스에서 반드시 생각해아할 점

1. 클래스는 꼭 필요한 경우가 아니면 불변이어야 한다. 따라서 꼭 필요한 경우가 아니라면 getter가 존재한다고 setter를 만들지 말자.
2. 모든 클래스를 불변으로 만들수는 없지만 불변으로 만들 수 없는 클래스여도 변 경할 수 있는 부분을 최소화 시켜야 한다.
3. 다른 합당한 이유가 없다면 모든 필드는 private final이여야 한다.
4. 생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 상태의 객체를 생성해야 한다.



추가적으로 읽어볼 링크

https://meetup.toast.com/posts/217